# 约束并行化方法

单核CPU实现下，通常使用Gauss-Seidel法来一个个的解决约束。粒子的位置可以在解约束的过程中即刻得到更新。但是在并行实现中，这么做很容易导致两个不同的约束会关于一个相同的粒子进行位置更新，这样做的后果是不可预料的。虽然可以使用原子操作进行同步，无疑这么做反而会降低并行速度。

## 1 Graph-Coloring Methods

一种方法是通过将这些约束进行分组或者分成不同的phases。我们只要保证在每一种phase下的约束们不会出现共享粒子的情况就好。在这样的限制下，每一个phase都可以无冲突的进行并行处理。并行处理完成后，就可以进行全局同步化，然后进入下一个phase，一直循环下去，直到所有的phase得到处理。

举例来说，假设有N个粒子被连成一行（一个接一个的），那么我们可以让约束1-2，3-4，5-6...作为phase 1，令2-3，4-5，6-7...作为phase 2。最经典的例子就是**Red-Black Gauss Seidel**策略，正好这个例子是有2组颜色的约束。

这样，将约束分为多个phase对应于graph coloring问题，其中每个约束对应于graph的一个node，并且如果两个约束影响一个或多个公共粒子，则两个约束通过一条边连接。color的最小数量决定了并行执行PBD时需要多少个phase。 保持phase个数较小不是唯一的优化标准，每个phase还需要具有相似的大小，以实现良好的负载平衡。

对于我们的布料模拟来说，结构约束、弯曲约束肯定是需要更多的phases的。对于结构约束来说，在三角网格下，一个粒子可能连接到五六个粒子上。而弯曲约束的情况则更复杂。所以，这种方法可能会导致颜色太多，负载很难达到平衡，有的phase约束多，有的phase约束很少。所以，这个方法应该是pass掉了。

真

## 2 Jacobi Methods

Jacobi方法收敛速度要比Gauss-Seidel法慢很多，并且可能根本无法收敛，因为系统矩阵可能根本不是正定的。要解决这个问题，可以考虑给予约束均衡的under relaxation方法[[BFA02]][BFA02]，或者质量分割法[[TBV12]][TBV12]。在迭代结束的时候，将粒子的总的约束变化量除以$n_i$(该粒子影响的约束的数量)，来得到平均的位置更新值$\Delta \tilde{\mathbf x}_i$
$$
\Delta \tilde{\mathbf x}_i = \frac{1}{n_i}\Delta \mathbf{x}_i
$$

当相邻粒子具有不同数量的约束时，不能保证这种形式的局部松弛会维持动量守恒。但是，视觉错误通常并不明显。 如上所述，不断施加约束力可确保收敛，但是在某些情况下，这种平均计算过于激进，并且达到解决方案所需的迭代次数也会增加。 为了解决这个问题，可以引入全局参数$\omega$来控制连续超松弛（SOR）的速率，
$$
\Delta \tilde{\bf x}_i=\frac{\omega}{n_i}\Delta \mathbf x_i
$$
我们建议使用$1\le\omega\le2$，尽管根据模拟场景可以使用更高的值。 通常不需要额外的低松弛$(\omega < 1)$，因为约束平均足以避免发散。

总结一下，这里的意思，应该是将所有的约束进行求解的时候，不进行位置更新，而是将位置的变化值$\Delta \mathbf x_i$记录下来，并且在所有的约束都求解完一次之后，执行上面的公式，进行更新，然后进行下一次的迭代运行。这个是目前我的一个理解。


## 3 Hybrid Methods

Hybrid Methods是由Fratarcangeli在[[FP15]][FP15]中提出的混合方法。首先使用graph coloring进行分类，将高价(high valence)粒子拆分为$k$种颜色。首先将$k-1$种颜色使用$k-1$个Gauss-Seidel passes，剩下的使用一个Jacobi pass。



## 4 Shape Matching

该方法和现在使用的方法相差有些大，需要修改基础模拟的模型，所以暂时不建议使用。

## 附录：静态迭代法求解线性方程组

静态迭代法，是形如
$$
\vec x^{(k+1)}=G\vec x^{(k)}+\vec c
$$
的迭代法，而$G$，$\vec c$不随迭代步数而变化，所以是静态迭代法。常见的迭代法：雅可比法（Jacobi method）、高斯-塞德尔法（Gauss-Seidel method）和松弛法（successive relaxation method）。

静态迭代法收敛的充分条件是，存在算子范数$||\cdot||$，使得$||G||<1$。更容易计算的充分条件是$G$的最大特征值的模小于$1$。

### 雅可比法

线性方程组的第$i$个方程为
$$
\sum_{j=1}^{n}a_{ij}x_j=b_i
$$
假设除了$x_i$，其他的未知数都已经解开，那么会有
$$
x_i=\frac{1}{a_{ii}}\left(b_i-\sum_{j=1,j\not=i}^{n}a_{ij}x_j\right)
$$
迭代公式即为
$$
x_i^{(k+1)}=\frac{1}{a_{ii}}\left( b_i - \sum_{j=1}^{i-1}a_{ij}x_j^{(k)} - \sum_{j=i+1}^{n}a_{ij}x_j^{(k)}\right)
$$
如果将矩阵$A$分解为三部分$A=L+D+U$，其中$L$为不包括对角线的下三角部分，$D$为对角线，$U$为不包括对角线的上三角部分，那么雅可比法的矩阵形式为
$$
\vec x^{(k+1)}=-D^{-1}(L+U)\vec x^{(k)}+D^{-1}\vec b
$$

### 高斯-塞德尔法

在雅可比法中，新值是用旧值代入解出的，而我们通常认为新值比旧值更接近精确解。如果$x_1^{(k)}$到$x_n^{(k+1)}$是按顺序依次计算的，那么在计算 $x_i^{(k+1)}$时可以用前面已经计算出来的 $i-1$个新值，即
$$
x_i^{(k+1)}=\frac{1}{a_{ii}}\left( b_i - \sum_{j=1}^{i-1}a_{ij}x_j^{(k+1)} - \sum_{j=i+1}^{n}a_{ij}x_j^{(k)}\right)
$$
高斯塞德尔法也可以写成矩阵形式
$$
\vec x^{(k+1)}= -D^{-1}L\vec x^{(k+1)} -D^{-1}U\vec x^{(k)} + D^{-1}\vec b
$$
或者
$$
\vec x^{(k+1)}= -(D+L)^{-1}U\vec x^{(k)} + (D+L)^{-1}\vec b
$$
这是采用从上到下的方式依次计算，其实也可以从下向上，就是将$L$与$U$互换一下就好。

###松弛法

松弛法，是由高斯-塞德尔的方法经过线性加速得到的。松弛法的基础是逐次减少每一个未知的剩余。其实松弛法可以看作是高斯-塞德尔方法的推广。

在高斯-塞德尔方法的基础上，我们添加一个增量概念$\Delta x_i^{(k)}$，有
$$
\Delta x_i^{(k)} = x_i^{(k+1)} - x_i^{(k)}
$$
我们将高斯-塞德尔一般公式，可以得到
$$
\begin{align}
\Delta x_i^{(k)} 
&= x_i^{(k+1)} - x_i^{(k)} \\
&= \frac{1}{a_{ii}}\left( b_i - \sum_{j=1}^{i-1}a_{ij}x_j^{(k+1)} - \sum_{j=i+1}^{n}a_{ij}x_j^{(k)}\right) - x_i^{(k)}
\end{align}
$$
对于迭代公式，变形为
$$
\begin{align}
x_i^{(k+1)}  
&= x_i^{(k)} + \Delta x_i^{(k)} \\
&= x_i^{(k)} + \left[ \frac{1}{a_{ii}}\left( b_i - \sum_{j=1}^{i-1}a_{ij}x_j^{(k+1)} - \sum_{j=i+1}^{n}a_{ij}x_j^{(k)}\right) - x_i^{(k)} \right]
\end{align}
$$
为了加快收敛速度，我们在增量$\Delta x_i^{(k)}$前面添加一个松弛因子$\omega$，最终公式为：
$$
x_i^{(k+1)} = (1-\omega)x_i^{(k)} + \frac{\omega}{a_{ii}}\left( b_i - \sum_{j=1}^{i-1}a_{ij}x_j^{(k+1)} - \sum_{j=i+1}^{n}a_{ij}x_j^{(k)}\right)
$$
从公式中可以看到，如果$\omega=1$，其实就是高斯-塞德尔公式。公式收敛条件为$0<\omega<2$，至于证明，没看懂。在$0<\omega <1$时，称为低松弛法（under-relaxation method）；当$1<\omega <2$时，称为超松弛法（over-relaxation method），这个条件下通常收敛较快。

逐次超松弛法（successive over-relaxation method，SOR）的矩阵形式如下：
$$
\vec x^{(k+1)} = (D+\omega L)^{-1}((1-\omega)D-\omega U)\vec x^{(k)} + \omega(D+\omega L)^{-1}\vec b
$$


## 附录

[FP15]: http://www.cse.chalmers.se/~marcof/pdf/eg15_ppbd.pdf "FRATARCANGELI M., PELLACINI F.: Scalable partitioning for parallel position based dynamics. EUROGRAPHICS 2015 34, 2 (2015). 26"

[ BFA02 ]: https://graphics.stanford.edu/papers/cloth-sig02/cloth.pdf "BRIDSON R., FEDKIW R., ANDERSON J.: Robust treatment of collisions, contact and friction for cloth animation. ACM Trans. Graph. 21, 3 (July 2002), 594–603. 26"

[ TBV12 ]: http://www.richardtonge.com/papers/Tonge-2012-MassSplittingForJitterFreeParallelRigidBodySimulation-preprint.pdf "TONGE R., BENEVOLENSKI F., VOROSHILOV A.: Mass splitting for jitter-free parallel rigid body simulation. ACM Trans. Graph. 31, 4 (July 2012), 105:1–105:8. 26"